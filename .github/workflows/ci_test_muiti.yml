name: ci-test-multi-jobs
on: pull_request
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
env:
  DOCKER_COMPOSE_VERSION: 1.19.0
  # DOCKER_VERSION: 18.06.0-ce
  DOCKER_VERSION: 5:19.03.11~3-0~ubuntu-bionic
  DOCKER_PWD: ${{ secrets.DOCKER_PWD }}
  DOCKER_LOGIN: ${{ secrets.DOCKER_LOGIN }}

jobs:
  # This workflow contains a single job called "build"
  build-api:
    # The type of runner that the job will run on
    runs-on: ubuntu-18.04
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: install docker-ce
        run: |
          # sudo apt-get remove docker docker-engine docker.io containerd runc
          sudo apt-get update
          # sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          # sudo apt-get install docker-ce docker-ce-cli containerd.io
          # sudo apt-get install docker-ce
          # apt-cache madison docker-ce
          sudo apt-get install docker-ce="$DOCKER_VERSION" docker-ce-cli="$DOCKER_VERSION" containerd.io
          type -a docker-compose && docker-compose version
          docker version
      - name: install dependency
        run: |
            sudo apt-get install -qy make apt-transport-https ca-certificates curl software-properties-common gawk jq parallel curl language-pack-fr
      - name: run test
        run: |
          ( git fetch --unshallow || true ) && git tag -l --sort=creatordate | tail -1
          ci/docker-access.sh
          ci/run-tests-api.sh
      - name:  Upload image
        uses: ishworkh/docker-image-artifact-upload@v1
        with:
          image: "candilib_api"
      - name: end
        run: |
          docker logout

  build-front-admin:
    # The type of runner that the job will run on
    runs-on: ubuntu-18.04
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: install docker-ce
        run: |
          # sudo apt-get remove docker docker-engine docker.io containerd runc
          sudo apt-get update
          # sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          # sudo apt-get install docker-ce docker-ce-cli containerd.io
          # sudo apt-get install docker-ce
          # apt-cache madison docker-ce
          sudo apt-get install docker-ce="$DOCKER_VERSION" docker-ce-cli="$DOCKER_VERSION" containerd.io
          type -a docker-compose && docker-compose version
          docker version
      - name: install dependency
        run: |
            sudo apt-get install -qy make apt-transport-https ca-certificates curl software-properties-common gawk jq parallel curl language-pack-fr
      - name: run test
        run: |
          ( git fetch --unshallow || true ) && git tag -l --sort=creatordate | tail -1
          ci/docker-access.sh
          ci/run-tests-front-admin.sh
      - name:  Upload image
        uses: ishworkh/docker-image-artifact-upload@v1
        with:
          image: "candilib_front_admin"
      - name: end
        run: |
          docker logout

  build-front-candidat:
    # The type of runner that the job will run on
    runs-on: ubuntu-18.04
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: install docker-ce
        run: |
          # sudo apt-get remove docker docker-engine docker.io containerd runc
          sudo apt-get update
          # sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          # sudo apt-get install docker-ce docker-ce-cli containerd.io
          # sudo apt-get install docker-ce
          # apt-cache madison docker-ce
          sudo apt-get install docker-ce="$DOCKER_VERSION" docker-ce-cli="$DOCKER_VERSION" containerd.io
          type -a docker-compose && docker-compose version
          docker version
      - name: install dependency
        run: |
            sudo apt-get install -qy make apt-transport-https ca-certificates curl software-properties-common gawk jq parallel curl language-pack-fr
      - name: run test
        run: |
          ( git fetch --unshallow || true ) && git tag -l --sort=creatordate | tail -1
          ci/docker-access.sh
          ci/run-tests-front-candidat.sh
      - name:  Upload image
        uses: ishworkh/docker-image-artifact-upload@v1
        with:
          image: "candilib_front_candidat"
      - name: end
        run: |
          docker logout

  build-mongodb:
    # The type of runner that the job will run on
    runs-on: ubuntu-18.04
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: install docker-ce
        run: |
          # sudo apt-get remove docker docker-engine docker.io containerd runc
          sudo apt-get update
          # sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          # sudo apt-get install docker-ce docker-ce-cli containerd.io
          # sudo apt-get install docker-ce
          # apt-cache madison docker-ce
          sudo apt-get install docker-ce="$DOCKER_VERSION" docker-ce-cli="$DOCKER_VERSION" containerd.io
          type -a docker-compose && docker-compose version
          docker version
      - name: install dependency
        run: |
            sudo apt-get install -qy make apt-transport-https ca-certificates curl software-properties-common gawk jq parallel curl language-pack-fr
      - name: run test
        run: |
          ( git fetch --unshallow || true ) && git tag -l --sort=creatordate | tail -1
          ci/docker-access.sh
          ci/run-tests-db.sh
      - name:  Upload image
        uses: ishworkh/docker-image-artifact-upload@v1
        with:
          image: "mongo"
      - name: end
        run: |
          docker logout

  build-test:
    # The type of runner that the job will run on
    runs-on: ubuntu-18.04
    needs: [build-mongodb, build-api, build-front-admin, build-front-candidat]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: install docker-ce
        run: |
          # sudo apt-get remove docker docker-engine docker.io containerd runc
          sudo apt-get update
          # sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          # sudo apt-get install docker-ce docker-ce-cli containerd.io
          # sudo apt-get install docker-ce
          # apt-cache madison docker-ce
          sudo apt-get install docker-ce="$DOCKER_VERSION" docker-ce-cli="$DOCKER_VERSION" containerd.io
          type -a docker-compose && docker-compose version
          docker version
      - name: install dependency
        run: |
            sudo apt-get install -qy make apt-transport-https ca-certificates curl software-properties-common gawk jq parallel curl language-pack-fr
      - name: Download image api
        uses: ishworkh/docker-image-artifact-download@v1
        with:
          image: "mongo"
      - name: Download image api
        uses: ishworkh/docker-image-artifact-download@v1
        with:
          image: "candilib_api"
      - name: Download image front admin
        uses: ishworkh/docker-image-artifact-download@v1
        with:
          image: "candilib_front_admin"
      - name: Download image front candidat
        uses: ishworkh/docker-image-artifact-download@v1
        with:
          image: "candilib_front_candidat"
      - name: run test
        run: |
          ( git fetch --unshallow || true ) && git tag -l --sort=creatordate | tail -1
          ci/docker-access.sh
          ci/run-tests-only.sh
      - name: store screenshots
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: screenshot test_e2e
          path: client/tests/e2e/screenshots
          retention-days: 1
      - name: deploy
        if: startsWith(github.head_ref, 'qualif/')
        env:
          HEROKU_TOKEN: ${{secrets.HEROKU_TOKEN}}
          HEROKU_EMAIL: ${{secrets.HEROKU_EMAIL}}
          NETLIFY_AUTH_TOKEN: ${{secrets.NETLIFY_AUTH_TOKEN}}
          HEROKU_APP_TEST: ${{secrets.HEROKU_APP_TEST}}
          HEROKU_APP_QUALIF: ${{secrets.HEROKU_APP_QUALIF}}
          HEROKU_APP_DEV: ${{secrets.HEROKU_APP_DEV}}
          SLACK_CHANNEL: ${{secrets.SLACK_CHANNEL}}
          SLACK_WEBHOOK: ${{secrets.SLACK_WEBHOOK}}
        run: |
          ci/deploy.sh qualif $TRAVIS_BRANCH
      - name:
        uses: geekyeggo/delete-artifact@v1
        with:
          name: |
            action_image_artifact_candilib_front_candidat
            action_image_artifact_candilib_api
            action_image_artifact_candilib_front_admin
            action_image_artifact_mongo
      - name: end
        run: |
          make clean-images clean-dir
          docker logout
